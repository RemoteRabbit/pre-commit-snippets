name: Publish Beta

on:
  push:
    branches: [main]

permissions:
  contents: write
  id-token: write

jobs:
  publish-beta:
    name: Publish Beta Release
    runs-on: ubuntu-latest
    # Skip if this is a release-please PR merge (version bump commit)
    if: ${{ !startsWith(github.event.head_commit.message, 'chore(main): release') }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install build toml

      - name: Compute dev version
        id: version
        run: |
          # Get current version from pyproject.toml
          CURRENT=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          
          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          # Increment patch for dev version
          NEXT_PATCH=$((PATCH + 1))
          
          # Create dev version with timestamp
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          DEV_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}.dev${TIMESTAMP}"
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "beta_tag=beta-${MAJOR}.${MINOR}.${NEXT_PATCH}" >> $GITHUB_OUTPUT
          
          echo "Current version: $CURRENT"
          echo "Dev version: $DEV_VERSION"

      - name: Update version for dev build
        run: |
          python -c "
          import toml
          
          with open('pyproject.toml', 'r') as f:
              data = toml.load(f)
          
          data['project']['version'] = '${{ steps.version.outputs.dev_version }}'
          
          with open('pyproject.toml', 'w') as f:
              toml.dump(data, f)
          "

      - name: Build package
        run: python -m build

      - name: Publish to PyPI (dev version)
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Create/update beta tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG="${{ steps.version.outputs.beta_tag }}"
          
          # Delete existing tag if it exists
          git tag -d "$TAG" 2>/dev/null || true
          git push origin --delete "$TAG" 2>/dev/null || true
          
          # Create new tag
          git tag "$TAG"
          git push origin "$TAG"
          
          echo "Updated tag: $TAG"
